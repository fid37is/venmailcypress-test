name: Cypress E2E Tests

on:
  push:
    branches: [main, staging, develop]
  pull_request:
    branches: [main, staging]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        default: 'staging'
        type: choice
        options: [dev, staging, production]
      test_suite:
        description: 'Test suite to run'
        required: true
        default: 'all'
        type: choice
        options: [all, smoke, regression, critical, sanity]
      browser:
        description: 'Browser to use'
        required: true
        default: 'chrome'
        type: choice
        options: [chrome, firefox, edge, electron]
      spec:
        description: 'Specific test file (optional)'
        required: false
        type: string
      parallel:
        description: 'Enable parallel execution'
        required: true
        default: true
        type: boolean
  schedule:
    - cron: '0 2 * * *'
    - cron: '0 */6 * * *'

env:
  DEV_URL: 'https://dev.venmail.io'
  STAGING_URL: 'https://app.venmail.io'
  PRODUCTION_URL: 'https://m.venmail.io'
  DEV_API_URL: 'https://api.dev.venmail.io'
  STAGING_API_URL: 'https://api.app.venmail.io'
  PRODUCTION_API_URL: 'https://api.venmail.io'
  CYPRESS_CACHE_FOLDER: .cache/Cypress
  NODE_ENV: test

jobs:
  setup:
    name: Setup Test Configuration
    runs-on: ubuntu-22.04
    outputs:
      app_url: ${{ steps.config.outputs.app_url }}
      api_url: ${{ steps.config.outputs.api_url }}
      environment: ${{ steps.config.outputs.environment }}
      browser: ${{ steps.config.outputs.browser }}
      spec: ${{ steps.config.outputs.spec }}
      grep_tags: ${{ steps.config.outputs.grep_tags }}
      test_suite: ${{ steps.config.outputs.test_suite }}
      parallel_count: ${{ steps.config.outputs.parallel_count }}
      
    steps:
      - name: Determine configuration
        id: config
        run: |
          BROWSER="chrome"
          TEST_SUITE="smoke"
          PARALLEL_COUNT=1
          GREP_TAGS="@ci"
          SPEC=""
          ENV="staging"
          
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV="${{ inputs.environment }}"
            BROWSER="${{ inputs.browser }}"
            TEST_SUITE="${{ inputs.test_suite }}"
            SPEC="${{ inputs.spec }}"
            if [ "${{ inputs.parallel }}" == "true" ]; then
              PARALLEL_COUNT=4
            fi
          
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            ENV="staging"
            TEST_SUITE="smoke"
            PARALLEL_COUNT=2
          
          elif [ "${{ github.event_name }}" == "push" ]; then
            if [ "${{ github.ref }}" == "refs/heads/main" ]; then
              ENV="production"
              TEST_SUITE="sanity"
            elif [ "${{ github.ref }}" == "refs/heads/staging" ]; then
              ENV="staging"
              TEST_SUITE="regression"
              PARALLEL_COUNT=4
            else
              ENV="dev"
              TEST_SUITE="smoke"
            fi
          
          elif [ "${{ github.event_name }}" == "schedule" ]; then
            ENV="staging"
            if [ "${{ github.event.schedule }}" == "0 2 * * *" ]; then
              TEST_SUITE="regression"
              PARALLEL_COUNT=4
            else
              TEST_SUITE="smoke"
              PARALLEL_COUNT=2
            fi
          fi
          
          # Set environment URLs
          case "$ENV" in
            dev)
              APP_URL="${{ env.DEV_URL }}"
              API_URL="${{ env.DEV_API_URL }}"
              ;;
            staging)
              APP_URL="${{ env.STAGING_URL }}"
              API_URL="${{ env.STAGING_API_URL }}"
              ;;
            production)
              APP_URL="${{ env.PRODUCTION_URL }}"
              API_URL="${{ env.PRODUCTION_API_URL }}"
              ;;
            *)
              APP_URL="${{ env.STAGING_URL }}"
              API_URL="${{ env.STAGING_API_URL }}"
              ;;
          esac
          
          # Set grep tags based on test suite
          case "$TEST_SUITE" in
            smoke)
              GREP_TAGS="@ci+@smoke"
              ;;
            critical)
              GREP_TAGS="@ci+@critical"
              ;;
            regression)
              GREP_TAGS="@ci"
              ;;
            sanity)
              GREP_TAGS="@ci+@sanity"
              ;;
            all)
              GREP_TAGS="@ci"
              ;;
            *)
              GREP_TAGS="@ci"
              ;;
          esac
          
          # If custom spec provided, don't filter by tags
          if [ -n "$SPEC" ]; then
            GREP_TAGS=""
          fi
          
          # Output all variables
          echo "app_url=$APP_URL" >> $GITHUB_OUTPUT
          echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "browser=$BROWSER" >> $GITHUB_OUTPUT
          echo "spec=$SPEC" >> $GITHUB_OUTPUT
          echo "grep_tags=$GREP_TAGS" >> $GITHUB_OUTPUT
          echo "test_suite=$TEST_SUITE" >> $GITHUB_OUTPUT
          echo "parallel_count=$PARALLEL_COUNT" >> $GITHUB_OUTPUT
          
          # Generate summary
          echo "### ğŸ§ª Test Configuration Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** \`$ENV\` ğŸ¯" >> $GITHUB_STEP_SUMMARY
          echo "- **App URL:** $APP_URL" >> $GITHUB_STEP_SUMMARY
          echo "- **API URL:** $API_URL" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Suite:** \`$TEST_SUITE\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Grep Tags:** \`$GREP_TAGS\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Browser:** \`$BROWSER\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Parallel Containers:** $PARALLEL_COUNT" >> $GITHUB_STEP_SUMMARY
          if [ -n "$SPEC" ]; then
            echo "- **Custom Spec:** \`$SPEC\`" >> $GITHUB_STEP_SUMMARY
          fi

  cypress-tests:
    name: Test (${{ matrix.containers }})
    needs: setup
    runs-on: ubuntu-22.04
    timeout-minutes: 60
    
    strategy:
      fail-fast: false
      matrix:
        containers: ${{ fromJson(format('[{0}]', needs.setup.outputs.parallel_count == '1' && '1' || needs.setup.outputs.parallel_count == '2' && '1,2' || '1,2,3,4')) }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache Cypress binary
        uses: actions/cache@v4
        with:
          path: ${{ env.CYPRESS_CACHE_FOLDER }}
          key: cypress-${{ runner.os }}-${{ hashFiles('package-lock.json') }}
          restore-keys: cypress-${{ runner.os }}-

      - name: Install dependencies
        run: |
          npm ci
          npm install --save-dev mochawesome mochawesome-merge mochawesome-report-generator @cypress/grep

      - name: Verify Cypress
        run: npx cypress verify

      - name: Wait for application
        run: |
          echo "ğŸ” Waiting for ${{ needs.setup.outputs.app_url }}"
          npx wait-on ${{ needs.setup.outputs.app_url }} --timeout 120000 --interval 3000
          echo "âœ… Application is ready"

      - name: Run Cypress tests
        uses: cypress-io/github-action@v6
        with:
          browser: ${{ needs.setup.outputs.browser }}
          spec: ${{ needs.setup.outputs.spec || 'cypress/e2e/**/*.cy.js' }}
          config: video=true,screenshotOnRunFailure=true,videoCompression=32
          config-file: cypress.config.js
          install: false
          record: false
          parallel: ${{ needs.setup.outputs.parallel_count > 1 }}
          group: ${{ needs.setup.outputs.test_suite }}-${{ needs.setup.outputs.environment }}
        env:
          CYPRESS_BASE_URL: ${{ needs.setup.outputs.app_url }}
          CYPRESS_API_URL: ${{ needs.setup.outputs.api_url }}
          CYPRESS_ENVIRONMENT: ${{ needs.setup.outputs.environment }}
          CYPRESS_TEST_SUITE: ${{ needs.setup.outputs.test_suite }}
          CYPRESS_grepTags: ${{ needs.setup.outputs.grep_tags }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
          # Environment-specific credentials
          CYPRESS_ADMIN_EMAIL: ${{ needs.setup.outputs.environment == 'production' && secrets.PRODUCTION_ADMIN_EMAIL || secrets.STAGING_ADMIN_EMAIL }}
          CYPRESS_ADMIN_PASSWORD: ${{ needs.setup.outputs.environment == 'production' && secrets.PRODUCTION_ADMIN_PASSWORD || secrets.STAGING_ADMIN_PASSWORD }}
          CYPRESS_SALES_EMAIL: ${{ needs.setup.outputs.environment == 'production' && secrets.PRODUCTION_SALES_EMAIL || secrets.STAGING_SALES_EMAIL }}
          CYPRESS_SALES_PASSWORD: ${{ needs.setup.outputs.environment == 'production' && secrets.PRODUCTION_SALES_PASSWORD || secrets.STAGING_SALES_PASSWORD }}
          CYPRESS_NORMAL_USER_EMAIL: ${{ needs.setup.outputs.environment == 'production' && secrets.PRODUCTION_NORMAL_USER_EMAIL || secrets.STAGING_NORMAL_USER_EMAIL }}
          CYPRESS_NORMAL_USER_PASSWORD: ${{ needs.setup.outputs.environment == 'production' && secrets.PRODUCTION_NORMAL_USER_PASSWORD || secrets.STAGING_NORMAL_USER_PASSWORD }}
          CYPRESS_NORMAL_USER_FIRSTNAME: ${{ needs.setup.outputs.environment == 'production' && secrets.PRODUCTION_NORMAL_USER_FIRSTNAME || secrets.STAGING_NORMAL_USER_FIRSTNAME }}
          CYPRESS_NORMAL_USER_LASTNAME: ${{ needs.setup.outputs.environment == 'production' && secrets.PRODUCTION_NORMAL_USER_LASTNAME || secrets.STAGING_NORMAL_USER_LASTNAME }}
          
        continue-on-error: true
        id: cypress_run

      - name: Retry failed tests (if any)
        if: steps.cypress_run.outcome == 'failure'
        uses: cypress-io/github-action@v6
        with:
          browser: ${{ needs.setup.outputs.browser }}
          spec: ${{ needs.setup.outputs.spec || 'cypress/e2e/**/*.cy.js' }}
          install: false
        env:
          CYPRESS_BASE_URL: ${{ needs.setup.outputs.app_url }}
          CYPRESS_API_URL: ${{ needs.setup.outputs.api_url }}
          CYPRESS_ENVIRONMENT: ${{ needs.setup.outputs.environment }}
          CYPRESS_grepTags: ${{ needs.setup.outputs.grep_tags }}
          
          # Same credential logic as above
          CYPRESS_ADMIN_EMAIL: ${{ needs.setup.outputs.environment == 'production' && secrets.PRODUCTION_ADMIN_EMAIL || secrets.STAGING_ADMIN_EMAIL }}
          CYPRESS_ADMIN_PASSWORD: ${{ needs.setup.outputs.environment == 'production' && secrets.PRODUCTION_ADMIN_PASSWORD || secrets.STAGING_ADMIN_PASSWORD }}
          CYPRESS_SALES_EMAIL: ${{ needs.setup.outputs.environment == 'production' && secrets.PRODUCTION_SALES_EMAIL || secrets.STAGING_SALES_EMAIL }}
          CYPRESS_SALES_PASSWORD: ${{ needs.setup.outputs.environment == 'production' && secrets.PRODUCTION_SALES_PASSWORD || secrets.STAGING_SALES_PASSWORD }}
          CYPRESS_NORMAL_USER_EMAIL: ${{ needs.setup.outputs.environment == 'production' && secrets.PRODUCTION_NORMAL_USER_EMAIL || secrets.STAGING_NORMAL_USER_EMAIL }}
          CYPRESS_NORMAL_USER_PASSWORD: ${{ needs.setup.outputs.environment == 'production' && secrets.PRODUCTION_NORMAL_USER_PASSWORD || secrets.STAGING_NORMAL_USER_PASSWORD }}
          CYPRESS_NORMAL_USER_FIRSTNAME: ${{ needs.setup.outputs.environment == 'production' && secrets.PRODUCTION_NORMAL_USER_FIRSTNAME || secrets.STAGING_NORMAL_USER_FIRSTNAME }}
          CYPRESS_NORMAL_USER_LASTNAME: ${{ needs.setup.outputs.environment == 'production' && secrets.PRODUCTION_NORMAL_USER_LASTNAME || secrets.STAGING_NORMAL_USER_LASTNAME }}
        continue-on-error: true
        id: retry_run

      - name: Upload test artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ needs.setup.outputs.environment }}-${{ matrix.containers }}-${{ github.run_number }}
          path: |
            cypress/results/**/*
            cypress/screenshots/**/*
            cypress/videos/**/*
          retention-days: 30
          if-no-files-found: warn

  report:
    name: Generate Test Report
    needs: [setup, cypress-tests]
    runs-on: ubuntu-22.04
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
        continue-on-error: true

      - name: Install report dependencies
        run: npm install --save-dev mochawesome mochawesome-merge mochawesome-report-generator

      - name: Merge test reports
        run: |
          mkdir -p cypress/results cypress/reports
          
          # Check if any JSON files exist
          if find artifacts -name "*.json" -type f 2>/dev/null | grep -q .; then
            find artifacts -name "*.json" -type f -exec cp {} cypress/results/ \;
            npx mochawesome-merge "cypress/results/*.json" > cypress/results/combined-report.json
            echo "âœ… Reports merged successfully"
          else
            echo "âš ï¸ No test result JSON files found - creating placeholder report"
            echo '{"stats":{"suites":0,"tests":0,"passes":0,"failures":0},"results":[]}' > cypress/results/combined-report.json
          fi
        continue-on-error: true

      - name: Generate HTML report
        run: |
          if [ -f cypress/results/combined-report.json ]; then
            npx marge cypress/results/combined-report.json \
              --reportDir cypress/reports \
              --reportTitle "Cypress E2E Test Report - ${{ needs.setup.outputs.environment }}" \
              --reportPageTitle "${{ needs.setup.outputs.test_suite }} Tests - ${{ needs.setup.outputs.environment }}" \
              --inline \
              --charts true \
              --code true
            echo "âœ… HTML report generated"
          else
            echo "âš ï¸ No combined report found - skipping HTML generation"
          fi
        continue-on-error: true

      - name: Upload consolidated report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: final-test-report-${{ needs.setup.outputs.environment }}-${{ github.run_number }}
          path: cypress/reports
          retention-days: 90
          if-no-files-found: warn

      - name: Generate test summary
        run: |
          echo "# ğŸ§ª Cypress Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Configuration" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | \`${{ needs.setup.outputs.environment }}\` ğŸ¯ |" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | \`${{ needs.setup.outputs.test_suite }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Grep Tags | \`${{ needs.setup.outputs.grep_tags }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| App URL | ${{ needs.setup.outputs.app_url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| API URL | ${{ needs.setup.outputs.api_url }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Browser | ${{ needs.setup.outputs.browser }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Trigger | \`${{ github.event_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Results" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.cypress-tests.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“Š [Download detailed HTML report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const testStatus = '${{ needs.cypress-tests.result }}';
            const emoji = testStatus === 'success' ? 'âœ…' : 'âŒ';
            const statusText = testStatus === 'success' ? 'All tests passed!' : 'Some tests failed';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ${emoji} E2E Test Results
              
              **Status:** ${statusText}
              **Environment:** \`${{ needs.setup.outputs.environment }}\` ğŸ¯
              **Test Suite:** \`${{ needs.setup.outputs.test_suite }}\`
              **Grep Tags:** \`${{ needs.setup.outputs.grep_tags }}\`
              **Browser:** \`${{ needs.setup.outputs.browser }}\`
              **App URL:** ${{ needs.setup.outputs.app_url }}
              **API URL:** ${{ needs.setup.outputs.api_url }}
              
              [View detailed results](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`
            });

  notify:
    name: Notify Team
    needs: [setup, cypress-tests, report]
    runs-on: ubuntu-22.04
    if: failure() && (github.event_name == 'schedule' || github.ref == 'refs/heads/main')
    
    steps:
      - name: Send notification
        run: |
          echo "ğŸš¨ Test Failed in ${{ needs.setup.outputs.environment }} environment"
          echo "Send notification to Slack/Teams/Email"
